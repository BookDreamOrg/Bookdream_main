<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
			"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PurchaseDAO">

	<resultMap type="purchase" id="purchaseList">
		<result property="purchase_no" column="PURCHASE_NO" />
		<result property="user_no" column="USER_NO" />
		<result property="book_no" column="BOOK_NO" />
		<result property="order_no" column="ORDER_NO" />
		<result property="product_count" column="PRODUCT_COUNT" />
		<collection property="userVO" resultMap="userList"></collection>		
		<collection property="bookVO" resultMap="bookList"></collection>
		<collection property="orderVO" resultMap="orderList"></collection>
	</resultMap>	

	<resultMap type="user" id="userList">
		<result property="user_no" column="USER_NO" />
	</resultMap>

	<resultMap type="book" id="bookList">
		<result property="book_no" column="BOOK_NO"/>
		<result property="title" column="TITLE" />
		<result property="book_price" column="BOOK_PRICE" />
		<result property="book_img" column="BOOK_IMG" />		
	</resultMap>

	<resultMap type="order" id="orderList">
		<result property="order_no" column="ORDER_NO"/>
	</resultMap>	
	
	
	<!-- user_no 수정필요 -->
	<insert id="insertPurchase">
		INSERT INTO PURCHASE (purchase_no, 
							  user_no, 
							  book_no, 
							  order_no, 
							  product_count)
		SELECT numplus.nextval, 
		       c.user_no, 
		       b.book_no, 
		       o.order_no, 
		       c.product_count
		FROM   book b, 
		       cart c, 
		       orders o
		WHERE  c.user_no = 1 AND 
			   b.book_no = c.book_no AND 
			   o.order_no = #{order_no}
	</insert>
	
	<select id="getPurchaseList" parameterType="purchase" resultMap="purchaseList">
		SELECT b.book_img, 
			   b.title, 
			   b.book_price, 
			   p.product_count,
			   p.purchase_no
		FROM   users u, 
			   book b, 
			   orders o, 
			   purchase p
		WHERE  b.book_no = p.book_no AND 
      		   o.order_no = p.order_no AND 
               o.order_no = #{order_no} AND 
     		   u.user_no = 1 	
	</select>
	
	
</mapper>

