<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
			"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
			
<mapper namespace="PayDAO">

	<resultMap type="pay" id="payList">
		<result property="pay_no" column="PAY_NO" />
		<result property="pay_date" column="PAY_DATE" />
		<result property="pay_method" column="PAY_METHOD" />
		<result property="user_no" column="USER_NO" />			
	</resultMap>

	<insert id="insertPay" >
		INSERT INTO pay(PAY_NO, 
						PAY_METHOD, 
						PAY_FEE,
						DISCOUNT_PRICE, 
						TOTAL_PRICE,
						FINAL_PRICE, 
						SAVE_POINT,
						USE_POINT) 
		VALUES ((select nvl(max(PAY_NO), 0) + 1 from pay), 
				 #{pay_method}, 
				 #{pay_fee},				 
				 #{discount_price}, 
				 #{total_price}, 
				 #{final_price}, 
				 #{save_point},
				 #{use_point}
			    )
	</insert>

	<select id="searchPay" resultMap="payList">
	<![CDATA[	
		SELECT pay_no, 
			   pay_date
		FROM   ( select * 
                 from pay 
                 order by pay_no desc
               )
        WHERE  rownum = 1
     ]]>
	</select>

	<select id="lastPayment" resultMap="payList">
		SELECT y.pay_method, 
		       y.pay_no
		FROM   pay y, 
		       orders o
		WHERE  o.user_no = ${user_no} AND
		       o.order_no = y.pay_no AND
		       rownum = 1
		order by pay_no desc		
	</select>
	
	<select id="payWekTotalPrice" resultType="HashMap">
	<![CDATA[		
		SELECT to_char(b.dt, 'MM-DD')as pay_date, 
               nvl(sum(a.total_prcie), 0) price
		FROM  (select to_date(pay_date, 'YY-MM-DD') as pay_date,
		              sum(final_price) total_prcie
		       from pay p, orders o
		       where to_date(pay_date, 'YY-MM-DD') between to_date(sysdate-4, 'YY-MM-DD') AND to_date(sysdate, 'YY-MM-DD') AND
                      p.pay_no = o.order_no and
                      o.order_status between 0 and 3
		       group by pay_date) a,      
		       
		      (select to_date(TO_DATE(sysdate-6,'YY/MM/DD') + LEVEL - 1, 'YY/MM/DD') AS dt
		       from dual 
		       CONNECT BY LEVEL <= (TO_DATE(sysdate,'YY/MM/DD') - TO_DATE(sysdate-6,'YY/MM/DD') + 1)) b
		WHERE b.dt = pay_date(+)
		group by b.dt
		order by b.dt 		
	]]>	
	</select>

	<select id="payMlyTotalPrice" resultType="HashMap">
	<![CDATA[		
		SELECT TO_CHAR(b.dt, 'YY-MM')as pay_date, 
               nvl(sum(a.total_price), 0) price
		FROM  (select to_date(pay_date, 'YY-MM-DD') as pay_date,
		              sum(final_price) total_price
		       from pay p, orders o
		       where to_date(pay_date, 'YY-MM-DD') between to_date('220801', 'YY-MM-DD') AND to_date('230228', 'YY-MM-DD') AND
                      p.pay_no = o.order_no and
                      o.order_status between 0 and 3
		       group by pay_date) a,      
		       
		      (select to_date(TO_DATE('220801','YY/MM/DD') + LEVEL - 1, 'YY/MM/DD') AS dt
		       from dual 
		       CONNECT BY LEVEL <= (TO_DATE('230228','YY/MM/DD') - TO_DATE('220801','YY/MM/DD') + 1)) b
		WHERE b.dt = pay_date(+)
		group by TO_CHAR(b.dt, 'YY-MM')
		order by TO_CHAR(b.dt, 'YY-MM') 		
	]]>	
	</select>



	
</mapper>